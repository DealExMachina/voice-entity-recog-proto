name: Deploy to Koyeb

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: sales-buddy

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test
      env:
        AI_PROVIDER: demo
        RATE_LIMIT_ENABLED: false

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to Koyeb
      env:
        KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        if [ -z "$KOYEB_TOKEN" ]; then
          echo "‚ö†Ô∏è  KOYEB_TOKEN not set - skipping deployment"
          exit 0
        fi
        
        # Install Koyeb CLI
        curl -fsSL -o koyeb.tar.gz "https://github.com/koyeb/koyeb-cli/releases/latest/download/koyeb_linux_amd64.tar.gz"
        tar -xzf koyeb.tar.gz
        sudo mv koyeb /usr/local/bin/koyeb
        chmod +x /usr/local/bin/koyeb
        
        # Login and deploy
        echo "$KOYEB_TOKEN" | koyeb auth login --token
        
        # Create app if needed
        if ! koyeb apps list --output json | jq -e ".apps[] | select(.name == \"$APP_NAME\")" > /dev/null 2>&1; then
          koyeb apps create $APP_NAME
        fi
        
        # Deploy with Git-based deployment (simpler than Docker)
        koyeb services create web \
          --app $APP_NAME \
          --git github.com/${{ github.repository }} \
          --git-branch ${{ github.ref_name }} \
          --git-build-command "npm ci && npm run build:production" \
          --git-run-command "npm start" \
          --env NODE_ENV=production \
          --env PORT=3000 \
          --env AI_PROVIDER=openai \
          --env OPENAI_API_KEY="$OPENAI_API_KEY" \
          --env DB_PATH=/tmp/entities.db \
          --env RATE_LIMIT_ENABLED=true \
          --ports 3000:http \
          --health-checks 3000:http:/api/health \
          --instance-type nano \
          --regions fra \
          --scale 1 || \
        koyeb services update web \
          --app $APP_NAME \
          --env OPENAI_API_KEY="$OPENAI_API_KEY"
        
        echo "üéâ Deployment completed!"
        echo "üåê Check your service at: https://app.koyeb.com/apps/$APP_NAME" 